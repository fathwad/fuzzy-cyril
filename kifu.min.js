(function(e){function c(k){this.size=parseInt(k)||19;this.stones=null;this._events={};this.clearBoard()}c.prototype.addEventListener=function(l,m){var k=this._events[l]=this._events[l]||[];k.push(m)};c.prototype.dispatchEvent=function(n,k){if(this._events.hasOwnProperty(n)){var m=this._events[n],l;for(l=0;l<m.length;l++){m[l].apply(this,k)}}};c.prototype.clearBoard=function(){this.stones=new Array(this.size);for(var k=0;k<this.stones.length;k++){this.stones[k]=new Array(this.size)}};c.prototype.addStone=function(k,o,m,l){if(k<this.stones.length&&o<this.stones.length&&!this.stones[k][o]){var n=new j(k,o,this,m);this.stones[k][o]=n;n.mergeGroup();n.killNeighbors()}if(!l){this.dispatchEvent("change")}};c.prototype.serialize=function(){var k={w:[],b:[],size:this.size},n,m,l;for(m=0;m<this.stones.length;m++){for(l=0;l<this.stones.length;l++){n=this.stones[m][l];if(n){k[n.color].push({x:m,y:l})}}}return JSON.stringify(k)};c.prototype.deserialize=function(k){if(typeof k==="string"){k=JSON.parse(k)}var l=this;l.size=k.hasOwnProperty("size")?k.size:19;l.clearBoard();if(k.hasOwnProperty("w")){k.w.forEach(function(m){l.addStone(m.x,m.y,"w",true)})}if(k.hasOwnProperty("b")){k.b.forEach(function(m){l.addStone(m.x,m.y,"b",true)})}this.dispatchEvent("change")};function j(k,n,m,l){this.x=k;this.y=n;this.board=m;this.color=l;this.group=null}j.prototype.neighbors=function(o,n){n=n||"map";var m=[{x:this.x-1,y:this.y},{x:this.x+1,y:this.y},{x:this.x,y:this.y-1},{x:this.x,y:this.y+1}],l=this.board,k=this;return m.filter(function(p){return p.x>=0&&p.y>=0&&p.x<l.stones.length&&p.y<l.stones.length})[n](function(p){return o.call(k,l.stones[p.x][p.y])})};j.prototype.mergeGroup=function(){var k=function(l){if(l&&l.color==this.color){var m=l.group;this.group=this.group||m||new g([this,l]);if(m){m.setNewGroup(this.group)}else{l.group=this.group;this.group.stones.push(l)}}};this.neighbors(k)};j.prototype.killNeighbors=function(){var k=function(m){if(m&&m.color!=this.color){var l=m.group||m;if(!l.hasLiberty()){l.die()}}};this.neighbors(k)};j.prototype.hasLiberty=function(){var k=function(l){return !l};return this.neighbors(k,"some")};j.prototype.die=function(){this.board.stones[this.x][this.y]=null;if(this.group){this.group.stones=this.group.stones.filter(function(k){return k!=this});this.group=null}};function g(l){this.stones=l;var k;for(k=0;k<l.length;k++){l[k].group=this}}g.prototype.setNewGroup=function(l){var k;if(this!=l){for(k=0;k<this.stones.length;k++){this.stones[k].group=l}l.stones=l.stones.concat(this.stones)}};g.prototype.hasLiberty=function(){return this.stones.some(function(k){return k.hasLiberty()})};g.prototype.die=function(){this.stones.forEach(function(k){k.group=null;k.die()})};function h(){this.board=new c();this.current_move=null;this.root_move=null}h.prototype.loadFromSgfString=function(s){var q=/\[[^\]]*\]/,m,p,n,l,o,v,t=[],r,u,k;this.board.clearBoard();while(s.length>0){r=s.search(q);if(r>=0){u=q.exec(s);k=s.substr(0,r).replace(/\s/g,"");s=s.substr(r+u[0].length);l="";while(k.length>0){o=k.charAt(0);k=k.substr(1);if(o==="("){if(p){t.push(m)}}else{if(o===")"){if(t.length>0){m=t.pop()}}else{if(o===";"){p=m;m=new f();n=n?n:m;if(p){p.addNextMove(m)}}else{l+=o}}}}l=l.trim();if(l){v=l}else{l=v}if(m){if(m.meta.indexOf(l)<0){m.meta+=" "+l;m.meta=m.meta.trim()}value=u[0].replace(/[\]\[]/g,"");if(l=="B"||l=="W"){m.color=l;m.position=value}else{if(l=="C"){m.comment=value}else{if(l=="AW"){m.aw.push(value)}else{if(l=="AB"){m.ab.push(value)}}}}}}else{k=s;s=""}}this.current_move=n;this.root_move=n;i(n,this.board);this.board.dispatchEvent("change")};function i(k,l){if(k){k.aw.forEach(function(m){var n=a(m);l.addStone(n[1],n[0],"w",true)});k.ab.forEach(function(m){var n=a(m);l.addStone(n[1],n[0],"b",true)})}}h.prototype.nextMove=function(){return this._nextMove(false)};h.prototype._nextMove=function(k){if(this.current_move.next_move){if(!this.current_move.raw_board){this.current_move.raw_board=this.board.serialize()}this.current_move=this.current_move.next_move;if(this.current_move.raw_board){this.board.deserialize(this.current_move.raw_board)}else{var l=a(this.current_move.position);if(l&&this.current_move.color){this.board.addStone(l[1],l[0],this.current_move.color.toLowerCase(),k)}i(this.current_move,this.board);if(!k){this.board.dispatchEvent("change")}this.current_move.raw_board=this.board.serialize()}}};h.prototype.previousMove=function(){if(this.current_move.previous_move){this.current_move=this.current_move.previous_move;this.board.deserialize(this.current_move.raw_board)}};h.prototype.playMove=function(){};h.prototype.jumpToMove=function(l,k){if(!k){k=[]}var m=0;this.current_move=this.root_move;this.board.clearBoard();while(m<l){this._nextMove(true);m++}this.board.dispatchEvent("change")};function f(){this.color=null;this.raw_board=null;this.comment="";this.position=null;this.next_move=null;this.previous_move=null;this.meta="";this.aw=[];this.ab=[]}f.prototype.addNextMove=function(k){if(this.next_move==null){this.next_move=k}else{if(this.next_move instanceof f){this.next_move=[this.next_move,k]}else{this.next_move.push(k)}}k.previous_move=this};function a(k){if(k){return[k.charCodeAt(0)-97,k.charCodeAt(1)-97]}else{return[]}}function d(r,k){var u=k.getContext("2d"),p=450,s=10,o,m,v,t,q,n,l;u.clearRect(0,0,500,500);u.beginPath();for(o=0;o<=18;o++){v=o/18*p+s;u.moveTo(v,s);u.lineTo(v,p+s)}for(o=0;o<=18;o++){t=o/18*p+s;u.moveTo(s,t);u.lineTo(p+s,t)}u.fillStyle="rgb(0,0,0)";for(o=3;o<=15;o++){for(m=3;m<=15;m++){if(o%6==3&&m%6==3){v=o/18*p+s;t=m/18*p+s;u.fillRect(v-3,t-3,6,6)}}}u.strokeStyle="rgb(0,0,0)";u.lineWidth=1;u.stroke();u.closePath();for(o=0;o<r.stones.length;o++){for(m=0;m<r.stones[o].length;m++){l=r.stones[o][m];if(l){q=l.x/18*p+s;n=l.y/18*p+s;u.beginPath();u.arc(q,n,p/(18*3),0,2*Math.PI);u.strokeStyle="rgb(0,0,0)";u.stroke();if(l.color=="b"){u.fillStyle="rgb(0,0,0)"}else{u.fillStyle="rgb(255,255,255)"}u.fill();u.closePath()}}}}e.fn.kifu=function(m){if(this.length==0||!this[0].getContext){return this}var l=this.data("kifu_record"),k=this;if(!l){l=new h();l.board.addEventListener("change",function(){d(this,k[0])});if(typeof m==="string"){if(b(m,".sgf")){return e.ajax({url:m,dataType:"text",success:function(n){l.loadFromSgfString(n);this.data("kifu_record",l)}})}else{l.loadFromSgfString(m)}}else{l.loadFromSgfString(this.html())}d(l.board,this[0]);this.data("kifu_record",l)}return l};function b(l,k){return l.indexOf(k,l.length-k.length)!==-1}})(jQuery);