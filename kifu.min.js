(function(d){function c(j){this.size=parseInt(j)||19;this.stones=null;this._events={};this.clearBoard()}c.prototype.addEventListener=function(k,l){var j=this._events[k]=this._events[k]||[];j.push(l)};c.prototype.dispatchEvent=function(m,j){if(this._events.hasOwnProperty(m)){var l=this._events[m],k;for(k=0;k<l.length;k++){l[k].apply(this,j)}}};c.prototype.clearBoard=function(){this.stones=new Array(this.size);for(var j=0;j<this.stones.length;j++){this.stones[j]=new Array(this.size)}};c.prototype.addStone=function(j,n,l,k){if(j<this.stones.length&&n<this.stones.length&&!this.stones[j][n]){var m=new i(j,n,this,l);this.stones[j][n]=m;m.mergeGroup();m.killNeighbors()}if(!k){this.dispatchEvent("change")}};c.prototype.removeStone=function(j,m,k){var l=this.stones[j][m];if(l){}};c.prototype.serialize=function(){var k={w:[],b:[],size:this.size},n,m,l;for(m=0;m<this.stones.length;m++){for(l=0;l<this.stones.length;l++){n=this.stones[m][l];if(n){k[n.color].push({x:m,y:l})}}}return JSON.stringify(k)};c.prototype.deserialize=function(j){if(typeof j==="string"){j=JSON.parse(j)}var k=this;k.size=j.hasOwnProperty("size")?j.size:19;k.clearBoard();if(j.hasOwnProperty("w")){j.w.forEach(function(l){k.addStone(l.x,l.y,"w",true)})}if(j.hasOwnProperty("b")){j.b.forEach(function(l){k.addStone(l.x,l.y,"b",true)})}this.dispatchEvent("change")};function i(j,m,l,k){this.x=j;this.y=m;this.board=l;this.color=k;this.group=null}i.prototype.neighbors=function(n,m){m=m||"map";var l=[{x:this.x-1,y:this.y},{x:this.x+1,y:this.y},{x:this.x,y:this.y-1},{x:this.x,y:this.y+1}],k=this.board,j=this;return l.filter(function(o){return o.x>=0&&o.y>=0&&o.x<k.stones.length&&o.y<k.stones.length})[m](function(o){return n.call(j,k.stones[o.x][o.y])})};i.prototype.rediscoverGroup=function(k){if(!k){k=new g()}console.log("rediscovering group");if(this.group){this.group.stones=this.group.stones.filter(function(l){return l!=this})}this.group=k;this.group.stones.push(this);var j=function(l){if(l&&this.color==l.color&&this.group!=l.group){l.rediscoverGroup(k)}};this.neighbors(j)};i.prototype.mergeGroup=function(){var j=function(k){if(k&&k.color==this.color){var l=k.group;this.group=this.group||l||new g([this,k]);if(l){l.setNewGroup(this.group)}else{k.group=this.group;this.group.stones.push(k)}}};this.neighbors(j)};i.prototype.killNeighbors=function(){var j=function(l){if(l&&l.color!=this.color){var k=l.group||l;if(!k.hasLiberty()){k.die()}}};this.neighbors(j)};i.prototype.hasLiberty=function(){var j=function(k){return !k};return this.neighbors(j,"some")};i.prototype.removeFromBoard=function(){this.board.stones[this.x][this.y]=null;if(this.group){this.group=null;this.neighbors(function(j){if(j&&this.color==j.color){j.rediscoverGroup()}})}};function g(k){if(!k){k=[]}this.stones=k;var j;for(j=0;j<k.length;j++){k[j].group=this}}g.prototype.setNewGroup=function(k){var j;if(this!=k){for(j=0;j<this.stones.length;j++){this.stones[j].group=k}k.stones=k.stones.concat(this.stones)}};g.prototype.hasLiberty=function(){return this.stones.some(function(j){return j.hasLiberty()})};g.prototype.die=function(){this.stones.forEach(function(j){j.group=null;j.removeFromBoard()})};function h(){this.board=new c();this.current_move=null;this.root_move=null;this._static_moves={w:{},b:{}}}h.prototype.loadFromSgfString=function(r){var p=/\[[^\]]*\]/,l,o,m,k,n,u,s=[],q,t,j;this.board.clearBoard();while(r.length>0){q=r.search(p);if(q>=0){t=p.exec(r);j=r.substr(0,q).replace(/\s/g,"");r=r.substr(q+t[0].length);k="";while(j.length>0){n=j.charAt(0);j=j.substr(1);if(n==="("){if(o){s.push(l)}}else{if(n===")"){if(s.length>0){l=s.pop()}}else{if(n===";"){o=l;l=new f();m=m?m:l;if(o){o.addNextMove(l)}}else{k+=n}}}}k=k.trim();if(k){u=k}else{k=u}if(l){if(l.meta.indexOf(k)<0){l.meta+=" "+k;l.meta=l.meta.trim()}value=t[0].replace(/[\]\[]/g,"");if(k=="B"||k=="W"){l.color=k;l.position=value}else{if(k=="C"){l.comment=value}else{if(k=="AW"){l.aw.push(value)}else{if(k=="AB"){l.ab.push(value)}else{if(k=="AE"){l.ae.push(value)}}}}}}}else{j=r;r=""}}this.current_move=m;this.root_move=m;this._addStatic();this.board.dispatchEvent("change")};h.prototype._addStatic=function(){var l=this.current_move,m,o,n,k=this._static_moves.w,j=this._static_moves.b;for(coded_coord in k){o=a(coded_coord);n=this.board.stones[o[1]][o[0]];if(n){n.removeFromBoard()}}for(coded_coord in j){o=a(coded_coord);n=this.board.stones[o[1]][o[0]];if(n){console.log(n);n.removeFromBoard()}}for(m=0;m<l.aw.length;m++){coded_coord=l.aw[m];delete j[coded_coord];k[coded_coord]=true}for(m=0;m<l.ab.length;m++){coded_coord=l.ab[m];delete k[coded_coord];j[coded_coord]=true}for(m=0;m<l.ae.length;m++){coded_coord=l.ae[m];delete j[coded_coord];delete k[coded_coord]}for(coded_coord in k){o=a(coded_coord);this.board.addStone(o[1],o[0],"w",true)}for(coded_coord in j){o=a(coded_coord);this.board.addStone(o[1],o[0],"b",true)}};h.prototype.nextMove=function(){return this._nextMove(false)};h.prototype._nextMove=function(j){if(this.current_move.next_move){if(!this.current_move.raw_board){this.current_move.raw_board=this.board.serialize()}this.current_move=this.current_move.next_move;if(this.current_move.raw_board){this.board.deserialize(this.current_move.raw_board)}else{var k=a(this.current_move.position);if(k&&this.current_move.color){this.board.addStone(k[1],k[0],this.current_move.color.toLowerCase(),j)}this._addStatic();if(!j){this.board.dispatchEvent("change")}this.current_move.raw_board=this.board.serialize()}}};h.prototype.previousMove=function(){if(this.current_move.previous_move){this.current_move=this.current_move.previous_move;this.board.deserialize(this.current_move.raw_board)}};h.prototype.playMove=function(){};h.prototype.jumpToMove=function(k,j){if(!j){j=[]}var l=0;this.current_move=this.root_move;this.board.clearBoard();while(l<k){this._nextMove(true);l++}this.board.dispatchEvent("change")};function f(){this.color=null;this.raw_board=null;this.comment="";this.position=null;this.next_move=null;this.previous_move=null;this.meta="";this.aw=[];this.ab=[];this.ae=[]}f.prototype.addNextMove=function(j){if(this.next_move==null){this.next_move=j}else{if(this.next_move instanceof f){this.next_move=[this.next_move,j]}else{this.next_move.push(j)}}j.previous_move=this};function a(j){if(j){return[j.charCodeAt(0)-97,j.charCodeAt(1)-97]}else{return[]}}function e(r,k){var u=k.getContext("2d"),p=450,s=10,o,m,v,t,q,n,l;u.clearRect(0,0,500,500);u.beginPath();for(o=0;o<=18;o++){v=o/18*p+s;u.moveTo(v,s);u.lineTo(v,p+s)}for(o=0;o<=18;o++){t=o/18*p+s;u.moveTo(s,t);u.lineTo(p+s,t)}u.fillStyle="rgb(0,0,0)";for(o=3;o<=15;o++){for(m=3;m<=15;m++){if(o%6==3&&m%6==3){v=o/18*p+s;t=m/18*p+s;u.fillRect(v-3,t-3,6,6)}}}u.strokeStyle="rgb(0,0,0)";u.lineWidth=1;u.stroke();u.closePath();for(o=0;o<r.stones.length;o++){for(m=0;m<r.stones[o].length;m++){l=r.stones[o][m];if(l){q=l.x/18*p+s;n=l.y/18*p+s;u.beginPath();u.arc(q,n,p/(18*3),0,2*Math.PI);u.strokeStyle="rgb(0,0,0)";u.stroke();if(l.color=="b"){u.fillStyle="rgb(0,0,0)"}else{u.fillStyle="rgb(255,255,255)"}u.fill();u.closePath()}}}}d.fn.kifu=function(l){if(this.length==0||!this[0].getContext){return this}var k=this.data("kifu_record"),j=this;if(!k){k=new h();k.board.addEventListener("change",function(){e(this,j[0])});if(typeof l==="string"){if(b(l,".sgf")){return d.ajax({url:l,dataType:"text",success:function(m){k.loadFromSgfString(m);this.data("kifu_record",k)}})}else{k.loadFromSgfString(l)}}else{k.loadFromSgfString(this.html())}e(k.board,this[0]);this.data("kifu_record",k)}return k};function b(k,j){return k.indexOf(j,k.length-j.length)!==-1}})(jQuery);